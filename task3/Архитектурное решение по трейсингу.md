**Покрытие трейсингом**

Изначальное описание:
```
Вот описание статусов заказа. В скобках указана система, в которой происходит изменение:
INITIATED [онлайн-магазин] — пользователь завёл новый заказ или положил товары в пустую корзину.
FILE_UPLOADED [онлайн-магазин] — пользователь загрузил файл с 3D-моделью или создал его с помощью конструктора.
SUBMITTED [онлайн-магазин] — пользователь нажал на кнопку «Сделать заказ».
PRICE_CALCULATED [MES] — система посчитала стоимость заказа.
MANUFACTURING_APPROVED [CRM] — заказ подтверждён, его можно отдавать в производство.
MANUFACTURING_STARTED [MES] — оператор взял заказ в работу.
MANUFACTURING_COMPLETED [MES] — оператор выполнил заказ.
PACKAGING [MES] — оператор начал упаковывать заказ.
SHIPPED [MES] — заказ отправлен покупателю.
CLOSED [CRM] — заказ завершён. Он закрывается после получения сообщения от транспортной компании или вручную.
```
Потенциально на любом из этапов смены статуса может возникнуть проблема. Соответственно, чтобы иметь 100% информацию о маршруте заказа и его текущем статусе, нужно покрыть трейсингом каждый этап.

| №   | Система | Статус | Потенциальная проблема           |
| --- | ------------ | ------------ | ---------------- |
| 1   | SHOP API     | INITIATED | Сессия зависла в момент подтверждения, а заказ создался. Пользователь же создает ещё один заказ чуть позже, аналогичный. Или пользователь положил в корзину, это сохранилось в кэше, который потом сбросился. Или клиенту отобразилось, что заказ сформировался, хотя в итоге заказ не сохранился в БД |
| 2   | SHOP API     | FILE_UPLOADED | Место в S3 закончилось, слишком долго загружались данные и сессия отвалилась по таймауту и т.д. |
| 3   | SHOP API     | SUBMITTED | Любая проблема с Shop DB, по которой не сохранился заказ |
| 4   | MES API     | PRICE_CALCULATED | Заказ успел удалиться/измениться, расчёт не зафиксировался; или расчёт выполнялся слишком долго и не рассчитался, заказ завис в статусе SUBMITTED |
| 5   | CRM API     | MANUFACTURING_APPROVED | Информация о рассчитанном заказе не дошла через очередь или продавца |
| 6   | MES API     | MANUFACTURING_STARTED | Оператор не увидел на зависающей стартовой странице новый заказ; заказ потерялся при перессылке из очереди в MES API из-за перегрузка последнего |
| 7   | MES API     | MANUFACTURING_COMPLETED | MES DB падал, данные затерлись/не обновились, оператор ошибочно в интерфейсе что-то не то сделал и т.д. |
| 8   | MES API     | PACKAGING | Оператор забыл перевести в новый статус, система была недоступна, потерялся заказ при отправке обновлений и т.д. |
| 9   | MES API     | SHIPPED | Любой человеческий фактор с ошибкой в интерфейсе + технические недоступности или потери данных |
| 10  | CRM API     | CLOSED | Апдейт статуса не дошёл до CRM из-за потери по дороге |

Итого видим, что необходимо покрыть трейсингом системы SHOP API, MES API и CRM API


**Мотивация**
1. Появится возможность найти точки, где заказы теряются. Соответственно, снизится процент потерянных заказов
2. Появится возможность мониторить зависшие заказы, т.к. можно будет навесить алерты на длительность пребывания по каждому статусу. Таким образом, оба пункта могут повлиять на повышение процента успешно выполненных заказов
3. Ускорение разбора ошибок, превентивное исправление проблем. В результате вырастет скорость выполнения заказов (за счет снижения времени работы над проблемными заказами), можно будет начать гарантировать SLA
4. Информацию о статусе заказа можно будет пробрасывать в интерфейс операторам. Это косвенно повлияет на качество и скорость работы над заказами.
5. По итогу пунктов выше вырастет удовлетворённость клиентов и снижение упущенной прибыли

**Предлагаемое решение**

В формате [drawio](/task3/jewerly_c4_model.drawio)

![](/task3/jewerly_c4_model.PNG)

Используем OpenTelemetry для генерации трейсинга + Jaeger для хранения и визуализации. Благодаря трейсингу по указанным API мы получим полное представление о движении заказов: а какой момент, в какой системе и в каком статусе был заказ

**Компромиссы**
1. Очень многое завязано на MES API (в т.ч. трассировка), но сейчас это скорее "черный ящик" - куплено с исходным кодом у вендора, внутри команды нет экспертизы. Есть ресурсы, которые могут разобраться и внедрить трассировку, но на это потребуется время
2. Продолжение предыдущего пункта. Есть более высокоприоритетные задачи, связанные с MES API, трассировка может переехать в техдолг. Да, она сделает разбор ошибок намного прозрачнее, но на первом этапе нужно в принципе разобраться со стабильностью сервиса
3. В целом система уже и так высоконагруженная, поэтому потенциально генерация и хранение трассировки может усугубить ситуацию в незрелой системе. Т.к. опыта настройки у команды нет, вариант ухудшения вполне реален.
4. Даже после успешного внедрения мы получаем дополнительный функционал, необходимый для поддержания. Это, конечно, не потребует найма отдельного разработчика, но некоторую нагрузку может увеличить, Хорошо, что вопрос с наймом открытый и опция усиления есть, главное учесть в том числе трассировку при расчёте дополнительных ресурсов

**Безопасность**
1. Средства трассировки вынести в отдельный защищенный сегмент
2. Сохранять только минимально необходимый объем информации, не использовать трассировку как логи
3. Доступ разграничить - только сотрудникам, которые занимаются разбором сбоев. Доступ долько после корпоративной аутентификации.
4. Включить полное логирование действий в UI
5. Использовать шифрование и защищенные протоколы