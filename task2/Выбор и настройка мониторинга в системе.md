**Мотивация**
1. Скорость решения проблем. Сейчас нет никакого понимания по следующим вопросам:
- где именно пропадают заказы
- почему долго выполняется расчет заказа
- почему долго открывается стартовая страница в MES
И так далее. По всем этим вопросам компания несет финансовые и репутационные потери. Соответствеено, решение этих вопросов напрямую скажется на благосостоянии компании
2. Понимание о возможном расширении
Уже был этап, когда не былы ясны возможности системы. В итоге подключили пользовательское API, количество клиентов выросло - поличество жалоб и потерь тоже. Чтобы адекватно оценивать дальнейшее масштабирование на другие рынки, на взрывные акции наподобие "черной пятницы", нужно понимать, какую нагрузку готова переварить система.

**Выбор подхода к мониторингу**
Будем использовать все три подхода.
USE - универсален для всех систем, будем обсчитывать инфраструктурные показатели
RED - основа, для всех систем
4 сигнала - для детализации и получения насыщенности - в первую очередь около MES API


**Выбранные метрики**
| №   | Метрика | Комментарий                                                                                                                                   |
| --- | ------------ | ---------------------------------------------------------------------------------------------------------------------------------------- |
| **I. MES API**                                                                                                                     |       |              |
| 1   | cpu_usage_percent             | Нехватка CPU, есть ли падения сервиса из-за этого                                       |
| 2   | memory_used_percent             | Нехватка памяти, есть ли падения сервиса из-за этого                                       |
| 3   | disk_usage_percent             | Проверка на переполнение диска (от логов, кэша и т.д.)                                       |
| 4   | mq_message_processing_rate             | Сколько сообщений в секунду обрабатывается от RabbitMq. Сравнивать с message_consume_rate в RabbitMq                                       |
| 5   | request_duration             | Время ответа на входящие запросы                                        |
| 6   | request_rate             | Количество входящих запросов                                        |
| 7   | error_rate             | Процент ошибок                                        |
| 8   | s3_request_rate             | Сколько запросов в секунду к S3                                       |
| 9   | s3_error_rate             | Сколько ошибок и какого типа к S3                                      |
| 10  | s3_record_time             | Сколько времени пишется в S3                                       |
| 11  | s3_record_size             | Размер объектов, записываемых сервисом в S3. Если s3_record_time большой, а s3_record_size маленький - проблемы с S3 или сетью                                        |
| 12  | garbage_coll_duration             | Т.к. Java и Spring, сколько времени уходит на работу garbage collector                                        |
| 13  | requests_in_progress             | Проверка, что значение стабильное, запросы не накапливаются                                        |
| 14  | thread_pool_utilization             | Есть ли свободные потоки, могут ли обрабатываться новые заказы                                        |
| **II. Rabbit MQ**                                                                                                                     |       |              |
| 1   | cpu_usage_percent             | Нехватка CPU, есть ли падения сервиса из-за этого                                       |
| 2   | memory_used_percent             | Нехватка памяти, есть ли падения сервиса из-за этого                                       |
| 3   | disk_usage_percent             | Переполнение диска и потеря данных                                       |
| 4   | queue_depth             | Расчищается ли очередь, не теряются ли сообщения из-за переполнения                                       |
| 5   | consumer_count             | Подключен ли MES API                                       |
| 6   | message_consume_rate             | Сколько сообщений доставляется консьюмерам, в данном случае MES API                                       |
| 7   | nack_rate              | Количество отклоненных сообщений сервисом. В зависимости от настроек сообщение или заново отправляется, или удаляется (теряется)                                       |
| 8   | publish_rate              | Опционально. Не помешает для дальнейшей оптимизации (публикуется в разы меньше сообщений, чем в пике может отправить очередь). А так пары queue_depth и message_consume_rate должно хватить для выявления проблем.                                        |
| **III. API User**                                                                                                                     |       |              |
| 1   | cpu_usage_percent             | Нехватка CPU, есть ли падения сервиса из-за этого                                       |
| 2   | memory_used_percent             | Нехватка памяти, есть ли падения сервиса из-за этого                                       |
| 3   | disk_usage_percent             | Проверка на переполнение диска (от логов, кэша и т.д.)                                       |
| 4   | latency             | Время ответа пользователю                                       |
| 5   | request_rate             | Частота обращений пользователей                                       |
| 6   | error_rate             | Количество ошибок и таймаутов                                       |
| **IV. БД MES**                                                                                                                     |       |              |
| 1   | cpu_usage_percent             | Нехватка CPU, есть ли падения сервиса из-за этого                                       |
| 2   | memory_used_percent             | Нехватка памяти, есть ли падения сервиса из-за этого                                       |
| 3   | disk_usage_percent             | Переполнение диска и потеря данных                                       | 
| 4   | disk_io_util             | Нагрузка на диск                                       |
| 5   | disk_await             | В совокупности с disk_io_util - насколько справляется диск с обработкой операций                                       | 
| 6   | latency             | Время выполнения запросов к БД                                       |
| 7   | queries_rate             | Количество запросов к БД                                       |
| 8   | connection_count             | Количество соединений к БД с учетом допустимого настроенного лимита в БД                                       |
| 9   | error_rate             | Количество ошибок при подключении к БД                                       |
| 10  | deadlock_count             | Количество дедлоков                                       |
| 11  | hard_queries             | Топ тяжелых запросов к БД                                       |
| **V. Остальные системы, работающие стабильно**                                                                                                                     |       |              |
| 1   | cpu_usage_percent             | Проверка на достаточность CPU                                       |
| 2   | memory_used_percent             | Проверка на достаточность памяти                                       |
| 3   | disk_usage_percent             | Проверка на переполнение диска (от логов, кэша и т.д.)                                       |
| 4   | health_check             | Проверка работы сервиса                                       |
| 5   | error_rate             | Процент и тип ошибок                                        |


**План действий**
1. Перечисленный выше список - для обнаружения и решения текущих проблем. Реализация через Prometheus + Grafana и мониторинг метрик
2. Выявление узких мест и поставка задач на их исправление
3. По мере высвобождения ресурсов анализируем общие метрики (5шт из пункта V) в других системах (SHOP API, S3 и т.д.) и по ним определяем, какой набор метрик подойдет для них. Т.к. по мере улучшения состояния в MES API бутылочные горлышки начнут образовываться в других системах
4. Улучшение мониторинга за счет автоматического алертинга, настройки пороговых значений, агрегирования ошибок и т.д.

**Показатели насыщенности**
| №   | Метрика | Порог           | Действия |
| --- | ------------ | ---------------- | ------------ |
| 1   | cpu_usage_percent             | 85%                                       | Краткосрочно - отключение некритичных тасок, долгосрочно - добавление ресурсов, планирование масштабирования |
| 2   | disk_usage_percent             | 85%                                       | Краткосрочно - удаление логов, долгосрочно - автоматизация удаления логов, архивация данных, добавление ресурсов |
| 3   | thread_pool_utilization             | 85%                                       | Краткосрочно - прибитие медленных процессов, долгосрочно - добавление ресурсов, оптимизация эндпоинтов, масштабирование |
| 4   | queue_depth              | Рост в течение 5 минут                                       | Краткосрочно - увеличение ресурсов на стороне MES API, торможение получения заказов, слив очереди во временный бэкап (промежуточный прокси-сервис), долгосрочно - оптимизация и ускорение работы MES API |
| 5   | connection_count              | 85% от max                                       | Краткосрочно - ручной kill долго выполняющихся сессий, долгосрочно - увеличение количества сессий в БД и/или нахождение утечек сессий |